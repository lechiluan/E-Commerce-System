{% extends "dashboard/base/ad_base.html" %}

{% block title %}Customer Management{% endblock %}
{% block style %}
    <style>

    </style>
{% endblock %}

{% load crispy_forms_tags %}
{% load crispy_forms_filters %}
{% load static %}

{% block content %}
    <h1 class="h2 mb-2 text-black-800">Customer Management</h1>
    <div class="breadcrumb">
        <a href="/dashboard/">Home</a>
        <span> > </span>
        <a href="/dashboard/customer_table/">Customer Management</a>
    </div>
    {# Searchbox bar right here#}
    <div class="search-form">
        <form action="/dashboard/search_customer/" method="post">
            {% csrf_token %}
            <div class="input-group search-manage">
                <input type="text" class="form-control border-0 small search-manage-input" placeholder="Search for..."
                       aria-label="Search" aria-describedby="basic-addon2" name="search">
                <input type="hidden" name="t" value="{{ timestamp }}">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search fa-sm"></i>
                    </button>
                    <a type="button" class="btn btn-danger" id="clear-btn" href="/dashboard/customer_table/">
                        <i class="fas fa-times fa-sm"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
    {# End of searchbox bar#}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <form id="delete-form" method="post" action="/dashboard/delete_selected_customer/">
                {% csrf_token %}
                <a type="button" class="btn btn-primary btn-md float-right button-add" href="/dashboard/add_customer/"
                   title="Add New"><img
                        src="{% static 'dashboard/images/icons/add.png' %}" class="add-icon" alt="Add New"
                        title="Add New"> Add New
                </a>

                <button type="button" id="delete-selected" class="btn btn-danger btn-md float-right button-delete"
                        title="Delete Selected" name="delete_selected" data-submit-form><img
                        src="{% static 'dashboard/images/icons/trash.png' %}" class="add-icon" alt="Delete Selected"
                        title="Delete Selected">Delete Selected
                </button>

                <button type="button" class="btn btn-success float-right dropdown-toggle button-delete btn-md"
                        data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false"><img
                        src="{% static 'dashboard/images/icons/export.png' %}" class="add-icon" alt="Export Data"
                        title="Export Data">
                    Export Data
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="/dashboard/export_customers/csv/">CSV</a>
                    <a class="dropdown-item" href="/dashboard/export_customers/xls/">Excel</a>
                </div>
            </form>
        </div>
        {% if users %}
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-auto table-style">
                        <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th scope="col">No.</th>
                            <th scope="col">ID</th>
                            <th scope="col">Username</th>
                            <th scope="col">Email</th>
                            <th scope="col">Full Name</th>
                            <th scope="col">Mobile</th>
                            <th scope="col">Address</th>
                            <th scope="col">Active</th>
                            <th scope="col">Staff</th>
                            <th scope="col">Admin</th>
                            <th scope="col">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                            <tr>
                                <td><input type="checkbox" class="select-checkbox" name="selected_customer"
                                           value="{{ user.id }}"></td>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                {% for customer in customers %}
                                    {% if customer.user == user %}
                                        <td>{{ customer.get_name }}</td>
                                        <td>{{ customer.mobile }}</td>
                                        <td>{{ customer.address }}</td>
                                    {% endif %}
                                {% empty %}
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                {% endfor %}
                                {% if user.is_active %}
                                    <td><img src="{% static 'dashboard/images/icons/icon-yes.svg' %}" alt="True"
                                             title="True"></td>
                                {% else %}
                                    <td><img src="{% static 'dashboard/images/icons/icon-no.svg' %}" alt="False"
                                             title="False"></td>
                                {% endif %}
                                {% if user.is_staff %}
                                    <td><img src="{% static 'dashboard/images/icons/icon-yes.svg' %}" alt="True"
                                             title="True"></td>
                                {% else %}
                                    <td><img src="{% static 'dashboard/images/icons/icon-no.svg' %}" alt="False"
                                             title="False"></td>
                                {% endif %}
                                {% if user.is_superuser %}
                                    <td><img src="{% static 'dashboard/images/icons/icon-yes.svg' %}" alt="True"
                                             title="True"></td>
                                {% else %}
                                    <td><img src="{% static 'dashboard/images/icons/icon-no.svg' %}" alt="False"
                                             title="False"></td>
                                {% endif %}
                                <td class="action">
                                    <a href="/dashboard/customer_details/{{ user.id }}"><img
                                            src="{% static 'dashboard/images/icons/detail.png' %}"
                                            alt="Details"
                                            title="Details"></a>
                                    <a href="/dashboard/update_customer/{{ user.id }}"><img
                                            src="{% static 'dashboard/images/icons/edit.png' %}"
                                            alt="Edit"
                                            title="Edit"></a>
                                    <a href="/dashboard/delete_customer/{{ user.id }}?t={{ timestamp }}"
                                       onclick="return confirm('Are you sure?')"><img
                                            src="{% static 'dashboard/images/icons/delete.png' %}"
                                            alt="Delete"
                                            title="Delete"></a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include 'dashboard/customer_management/pagination.html' %}
            </div>
        {% else %}
            {% include 'dashboard/customer_management/404.html' %}
        {% endif %}
    </div>


{% endblock %}

{% block scripts %}
    <script>
        // Delete selected function
        document.addEventListener("DOMContentLoaded", function () {
            // Get the form and the delete selected button
            let form = document.getElementById("delete-form");
            let deleteBtn = document.querySelector("[data-submit-form]");
            let selectAllCheckbox = document.getElementById("select-all");

            // Listen for the click event on the delete selected button
            deleteBtn.addEventListener("click", function (event) {
                // Get the selected checkboxes
                let checkboxes = document.querySelectorAll(".select-checkbox:checked");
                // If no checkboxes are selected, prevent the form submission
                if (checkboxes.length === 0) {
                    event.preventDefault();
                    alert("Please select at least one customer to delete.");
                } else {
                    // Update the action attribute of the form
                    let customerIds = Array.from(checkboxes).map(function (checkbox) {
                        return checkbox.value;
                    });
                    form.action = "/dashboard/delete_selected_customer/" + customerIds.join("+") + "/";
                    // Submit the form
                    form.submit();
                }
            });

            // Listen for the click event on the select-all checkbox
            selectAllCheckbox.addEventListener("click", function () {
                // Get all the customer checkboxes
                let customerCheckboxesAll = document.querySelectorAll(".select-checkbox");
                // Set their checked property based on the select-all checkbox
                customerCheckboxesAll.forEach(function (checkbox) {
                    checkbox.checked = selectAllCheckbox.checked;
                    let customerIds = Array.from(customerCheckboxesAll).map(function (checkbox) {
                        return checkbox.value;
                    });
                    form.action = "/dashboard/delete_selected_customer/" + customerIds.join("+") + "/";
                });
            });
        });
    </script>
{% endblock %}